<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.111.3"><title>How to Find the Last Record in a Group Using KQL | Jordi Smit</title><meta name=description content="Today I learned how to use KQL's arg_max function to find the last record in a log time interval group in Azure's Application Insight."><meta name=keywords content="azure,kql,application insight,monitoring"><link rel=canonical href=https://jordismit.com/til/how-to-find-the-last-record-in-a-group-using-kql/><meta property="og:type" content="website"><meta property="og:title" content="How to Find the Last Record in a Group Using KQL | Jordi Smit"><meta property="og:description" content="Today I learned how to use KQL's arg_max function to find the last record in a log time interval group in Azure's Application Insight."><meta property="og:site_name" content="Jordi Smit"><meta property="og:url" content="https://jordismit.com/til/how-to-find-the-last-record-in-a-group-using-kql/"><meta property="og:locale" content="en"><meta property="og:image" content="https://jordismit.com/til/how-to-find-the-last-record-in-a-group-using-kql/images/cover.jpg"><meta property="og:image:secure_url" content="https://jordismit.com/til/how-to-find-the-last-record-in-a-group-using-kql/images/cover.jpg"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to Find the Last Record in a Group Using KQL"><meta name=twitter:description content="Today I learned how to use KQL's arg_max function to find the last record in a log time interval group in Azure's Application Insight."><link rel=stylesheet href=https://jordismit.com/css/bootstrap.min.60b19e5da6a9234ff9220668a5ec1125c157a268513256188ee80f2d2c8d8d36.css integrity="sha256-YLGeXaapI0/5IgZopewRJcFXomhRMlYYjugPLSyNjTY="><link rel=stylesheet href=https://jordismit.com/css/goolge-fonts.min.59f98c25da594b2a690835ae556add4bd6b87b555c2be822e4f8d7ed2ac28c55.css integrity="sha256-WfmMJdpZSyppCDWuVWrdS9a4e1VcK+gi5PjX7SrCjFU="><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.13/css/all.css integrity=sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp crossorigin=anonymous><link rel=stylesheet href=https://jordismit.com/css/medium.min.e66d0e4ae688e3a5810c787217a0415a08000e0855cdfdd538f874f3b5a3273f.css integrity="sha256-5m0OSuaI46WBDHhyF6BBWggADghVzf3VOPh087WjJz8="><link rel=stylesheet href=https://jordismit.com/css/additional.min.367d6ec3565355818ede31d5db72442ef6ae21568fc7bd015286acecabe11257.css integrity="sha256-Nn1uw1ZTVYGO3jHV23JELvauIVaPx70BUoas7KvhElc="><link rel=icon type=image/x-icon href=https://jordismit.com/favicon/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=https://jordismit.com/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://jordismit.com/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://jordismit.com/favicon/favicon-16x16.png><meta name=theme-color content="#fff"></head><body class="d-flex flex-column min-vh-100"><nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"><div class="container pr-0"><a class=navbar-brand href=https://jordismit.com/><span style=font-family:Righteous>Jordi Smit</span></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarMediumish aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarMediumish><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/blog>Blog</a></li><li class=nav-item><a class=nav-link href=/til>TIL</a></li><li class=nav-item><a class=nav-link href=/cheat-sheets>Cheat-sheets</a></li><li class=nav-item><a class=nav-link href=/about>About Me</a></li></ul></div></div></nav><div class=site-content><div class=container><div class=main-content><div class=container><div class=row><div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset"><p>Share</p><ul><li class="ml-1 mr-1"><a target=_blank href="https://twitter.com/intent/tweet?text=How%20to%20Find%20the%20Last%20Record%20in%20a%20Group%20Using%20KQL&url=https%3a%2f%2fjordismit.com%2ftil%2fhow-to-find-the-last-record-in-a-group-using-kql%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=435"),!1'><i class="fab fa-twitter"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://facebook.com/sharer.php?u=https%3a%2f%2fjordismit.com%2ftil%2fhow-to-find-the-last-record-in-a-group-using-kql%2f" onclick='return window.open(this.href,"facebook-share","width=550,height=435"),!1'><i class="fab fa-facebook-f"></i></a></li><li class="ml-1 mr-1"><a target=_blank href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fjordismit.com%2ftil%2fhow-to-find-the-last-record-in-a-group-using-kql%2f" onclick='return window.open(this.href,"linkedin-share","width=550,height=435"),!1'><i class="fab fa-linkedin"></i></a></li></ul></div></div><div class="col-md-9 flex-first flex-md-unordered"><div class=mainheading><div class="row post-top-meta"><div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right"><a href=/about><img class=author-thumb src=https://jordismit.com/media/images/author_hu25d333fcded103db2f52f7476cb1420a_204682_250x0_resize_q75_box.jpg alt=Author></a></div><div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left"><a href=/about class=link-dark>Jordi
Smit</a><br><span class=author-description>Machine Learning Engineer<br>Oct 31, 2022
<i class="far fa-clock clock"></i>
2 min read</span></div></div><h1 class=posttitle>How to Find the Last Record in a Group Using KQL</h1></div><div class=post-featured-image><img class=img-fluid src=https://jordismit.com/til/how-to-find-the-last-record-in-a-group-using-kql/images/cover.jpg alt="thumbnail for this post"></div><div class=article-post><p>Today, I was building a dashboard in Azure&rsquo;s <a href=https://learn.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview>Application Insight</a> that needed to show the number of deployments behind each load balancer over time in an application.
All the deployments in this application are periodically queried for the current health status via a health REST API call.
Each application logs its unique deployment ID and load balancer ID during this health request to Azure&rsquo;s Application insights.
So to create this dashboard, I had to do the following:</p><ol><li>Group all the health requests in a given interval by their deployment ID, load balancer ID, and interval and take the last record in this group.</li><li>Group all the remaining records by their load balancer ID and count the number of deployments.</li><li>Create a plot that shows the total number of deployments per load balancer over time.</li></ol><p>Today I learned that you could implement step 1 using the <a href=https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/arg-max-aggfunction>arg max</a> function in Azure&rsquo;s Application Insight querying language (KQL).
The <code>arg_max(x, y) by z1, ..., zn</code> function finds the record with the largest value for <code>x</code> in group <code>z_i</code> and then returns the columns <code>y</code>.
In our case, we can use <code>summarize arg_max(timestamp, *) by endpoint, deployment, bin(timestamp, 5m)</code> to find the record with the largest timestamp in our endpoint, deployment, and interval group.
In this case, we use <code>*</code> to indicate that the <code>arg_max</code> function should return all the columns of the selected record.
So, with this new insight, we can get the data for our dashboard using the following KQL query.</p><pre tabindex=0><code class=language-kql data-lang=kql>requests
// add our custom data to query.
| extend
    endpoint = tostring(customDimensions[&#34;load_balancer_id&#34;]),
    deployment = tostring(customDimensions[&#34;deployment_id&#34;])
// obtain the last health check record at 5m intervals
| summarize arg_max(timestamp, *) by endpoint, deployment, bin(timestamp, 5m)
// count the number of deployments at 5m intervals
| summarize number_of_deployments=count() by endpoint, bin(timestamp, 5m)
</code></pre></div><div class=after-post-tags><ul class=tags><li><a href=/tags/azure>azure</a></li><li><a href=/tags/kql>kql</a></li><li><a href=/tags/application-insight>application insight</a></li><li><a href=/tags/monitoring>monitoring</a></li></ul></div><div class="row PageNavigation d-flex justify-content-between font-weight-bold"><a class="d-block col-md-6 text-lg-right" href=https://jordismit.com/til/how-to-pass-data-to-pytest-fixtures-from-the-cli/>How to pass data to PyTest fixtures from the CLI &#187;</a><div class=clearfix></div></div></div></div></div></div></div></div><footer class="footer mt-auto"><div class=container><div class=row><div class="col-md-12 col-sm-612 text-center">&copy; Copyright
Jordi Smit - All rights reserved</div></div></div></footer><script async src=https://jordismit.com/js/mediumish.min.9d9d966a5fcd9fe6f66e99d7d39ffd341eedde773a8b096c898da98e0560da7d.js integrity="sha256-nZ2Wal/Nn+b2bpnX05/9NB7t3nc6iwlsiY2pjgVg2n0="></script></body></html>